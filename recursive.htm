<!doctype html><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
h3,h2,h1{margin:0;display:inline-block}
body{
  font-family:sans-serif;
  transition:background-color 0.3s;
  user-select:none;
  overflow:hidden;
  touch-action:none;
}
pre{background:rgba(128,128,128,0.2)}
.note{
  cursor:auto;
  position:absolute;
  border:2px solid;
  border-radius:3px;
  opacity:0.9; box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  min-height:50px; min-width:50px;
  resize:both; overflow:auto;
}
.note.pinned {box-shadow:1px 1px 2px rgba(0,0,0,0.3);resize:none;}
.note.selected {outline:2px dashed;}
.note svg{z-index:-1}
.note img{max-width:100%}
.subnote {
  position:absolute;
  border: 1px solid;
  box-shadow:2px 2px 2px rgba(0,0,0,0.3);
  z-index:-1;
}
ul{margin:0}
.gear{
  cursor:pointer;
  position:absolute; right:0;
  width:13px; height:13px;
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOtJREFUeNp8kj0LwkAMhtterau26uCgIPixOIiTf91fIeiiIo6C2joIFj/rG3kPwlE8eOglby6X5Gq88jUCMxCAsysG/PpgABL6OvR3aCfUfRssa0inrBcIVWJtb8Da3pSpoNCpRtupdojxBgbcwYqJYjAGEfVfcsOmJ6DCBAtwYFlXkIM2e+tKnNzUd8q5/LGrEi+nd+CphNg5VFd7idtJeSewBz013pwBLfZk2NMcHEOVzagSpiUPLnpNhmZH3lDixwnWdtNT2TM+9BYsOSXRHiwpZcnyuIU9VPAfu3EfcSDS65H+MzXvK8AAT5g1PwYr5mUAAAAASUVORK5CYII=)
}
.hl{box-shadow: inset 0px 0px 50px white, 5px 5px 5px rgba(0,0,0,0.3) !important; opacity:0.5}
.invis{box-shadow:none; border-color:transparent; resize:none;}
.invis:hover{border-color:rgba(128,128,128,0.2);background:rgba(128,128,128,0.1); resize:both;}
.invis .gear{display:none;}
.invis:hover .gear{display:block}
.invis.pinned{box-shadow:none}
.invis.pinned:hover{border-color:transparent;resize:none;}
#menu{
  display:none;
  position:absolute;
  z-index:2;
  background:#eee;
  border:3px solid #ccc;
  border-radius:3px;
  box-shadow:5px 5px 5px rgba(0,0,0,0.3);
  min-width:200px
}
#menu p{margin:7px}
#canvas{
  position:absolute;
  top:0;left:0;
}
#main{
  transform-origin: 0% 0%;
  position:absolute;
  top:0;left:0;
  margin:0;
  transition:opacity 0.3s;
}
#main.panning>div.note{
  cursor:inherit;
}
#trail{
  position:absolute;
  background:rgba(128,128,128,0.3);
  width:100%;
  height:32px;
  left:0;top:0;
  overflow:hidden;
  white-space:nowrap;
  direction:rtl;
  text-align:left;
}
#trail a{
  direction:ltr;
  color:#000; text-decoration:none;
  display:inline-block;
  padding:3px;
  border:2px solid red;
  border-radius:3px;
  margin:2px;
}
#trail a:hover{opacity:0.6}
#trail a.drop {border:2px dashed;opacity:0.5}
svg{position:absolute;left:0;top:0;transition:opacity 0.3s;transform-origin:0 0}
#outline {
  padding:10px;
  position:absolute;
  left:0;
  top:0px;
  width:calc(100% - 28px);
  height:calc(100% - 42px);
  overflow:auto;
}
#outline a{
  color:black;
  text-decoration:none;
  white-space: nowrap;
  padding:2px;
  opacity:0.8;
}
#outline a:hover{opacity:1}
#outline a.drop {outline:1px dashed black;opacity:0.5}
details p{
  white-space:nowrap;
  line-height:23px;
  margin:0 0 0 15px;
}
details>p{display:inline-block;}
.sresult{opacity:0.1 !important;}
#sidebarLeft{
  background:rgba(255,255,255,0.9);
  position:absolute;
  z-index:2;
  left:-200px;
  top:32px;
  width:200px;
  height:calc(100% - 32px);
  transition: left 0.2s;
}
#sidebarLeftAdj{
  cursor:ew-resize;
  width:8px;
  height:100%;
  background:#999;
  position:absolute;
  right:0;
  top:0;
}
#searchInput{
  position:absolute;
  bottom:0;
  left:0;
  width:calc(100% - 8px);
  height:22px;
}
#toolbar {
  position:absolute;
  z-index:2;
  top:32px;left:0;
  width:32px;
  background:rgba(128,128,128,0.3);
}
#toolbar input, #toolbar button{vertical-align: middle;}
#toolbar label{
  display:inline-block;
  width:100px;
  text-align:right;
  margin-right:5px;
  line-height:32px;
}
#toolbox {width:32px;}
.tool {
  width:28px;
  height:28px;
  background-color: #ddd;
  background-repeat: no-repeat;
  background-position:0 0;
  border: 2px outset;
  margin:2px;
}
.tool.active, .tool:active{
  border: 2px inset;
  background-color: #bbb;
  background-position:1px 1px;
}
#drawingControls{
  position:absolute;
  z-index:-1;
  padding:12px;
  border-radius:0 10px 10px 0;
  background:rgba(212,212,212,0.8);
  width:280px;
  left:-280px;
  top:115px;
  opacity:0;
  transition:0.2s;
}
#toolbox:hover+#drawingControls, #drawingControls:hover{
  left:32px;
  opacity:1;
}

#help {
  display:none;
  position:fixed;
  z-index:99;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
}
#help div{
  margin:10vh auto;
  width:810px;
  height:76vh;
  background:white;
  padding:2vh 2vw;
  overflow:auto;
}
@media(max-width:900px) {
  #help div{width:90vw;}
}
#help table{margin:auto}
#help tr:hover{background:#eee}
#help td{padding:2px 15px}
#marquee{
  display:none;
  position:absolute;
  border:2px dashed;
  cursor:crosshair;
}
</style>
<div id=canvas>
<svg><g></g></svg>
<div id=main></div>

<div id=toolbar>
<div id=toolbox></div>

<div id=drawingControls>
<div><label>color:</label><input id=pencolor type=color oninput='penColor=this.value'></div>
<div><label>thickness:</label><input id=penwidth type=range oninput='penWidth=this.value+"px"' min=1 max=10 value=3></div>
<div><label>arrow style:</label>
 <select id=arrowstyle oninput='arrowStyle=this.value; setPenTool("arrow")'>
  <option value='1'>⯈</option>
  <option value='2'>➤</option>
  <option value='3' selected>ᐅ</option>
  <option value='4'>⮚</option>
  <option value='5'>ᐳ</option>
 </select>
</div>
<div><label>arrow size:</label><input id=arrowsize type=range oninput='arrowSize=this.value/50; setPenTool("arrow")' min=3 max=10 value=6></div>
 <a href='#' onclick='eraseAllLines(); return false'>erase all lines</a>
</div>

</div>
</div>

<div id=marquee></div>

<div id=menu>
  <p>Change color <input id=notecolor type=color onchange='changeColor()'><br>(use black for transparent)
  <p><a href='#' onclick='editNote(); return false'>Edit</a>
  <p><a href='#' onclick='menuAction(toggleStrike); return false'>Toggle strikethrough</a>
  <p><a href='#' onclick='menuAction(togglePinned); return false'>Toggle pinned</a>
  <p><a href='#' onclick='jumpInto(); return false' id=jumpInto>Jump Into</a>
  <p><a href='#' onclick='moveUpNote(); return false'>Move up a level</a>
  <p><a href='#' onclick='deleteNote(); return false'>Delete</a>
</div>

<div id=trail></div>
<div id=sidebarLeft>
 <div id=outline></div>
 <form onsubmit="jumpFirstSearch(); return false">
  <input id=searchInput type=search placeholder=Search oninput="search(this)" tabindex=1>
 </form><br>
 <div id=sidebarLeftAdj></div>
</div>

<div id=help onclick='if (event.target==this) closeHelp();'>
<div>
<p>Click and drag to move note
<p>Drag corners to resize
<p>Right click note body to expand, double click to edit text
<p>Middle-click drag to pan, scroll to zoom
<p>Drawing tools: Left click drag on background to draw, right click erase
<p>Sidebar: drag &amp; drop a note onto another to move it
<p><a href=# onclick='downloadJson(); return false'>Download the current state</a>, drag & drop .json file onto this page to load
<p><a href='#' onclick='if (confirm("reset?")){localStorage.tree="";location.hash="";location.reload()} else return false'>Delete everything and reset</a>

<p>Keyboard shortcuts:
<table>
<tr><td>Arrow keys</td><td>pan</td></tr>
<tr><td>- or PageDown</td><td>zoom out</td></tr>
<tr><td>+ or PageUp</td><td>zoom in</td></tr>
<tr><td>Home</td><td>zoom 100%</td></tr>
<tr><td>End</td><td>zoom to fit</td></tr>
<tr><td>T</td><td>Add-Note tool</td></tr>
<tr><td>M</td><td>Marquee tool</td></tr>
<tr><td>B</td><td>Pencil tool</td></tr>
<tr><td>L</td><td>Draw Line tool</td></tr>
<tr><td>A</td><td>Draw Arrow tool</td></tr>
<tr><td>R</td><td>Draw Rectangle tool</td></tr>
<tr><td>E</td><td>Eraser tool</td></tr>
<tr><td>H</td><td>Hand tool</td></tr>
<tr><td>Z</td><td>Zoom tool</td></tr>
<tr><td>S</td><td>Toggle sidebar</td></tr>
<tr><td>/</td><td>Focus Search</td></tr>
<tr><td>Delete</td><td>Delete marquee selection</td></tr>
<tr><td>Escape</td><td>Unequip tool</td></tr>
<tr><td>Ctrl + Z</td><td>Undo</td></tr>
<tr><td>Ctrl + A</td><td>Select All</td></tr>
</table>
<p><a href=# onclick='closeHelp(); return false'>Close</a>
</div>
</div>

<pre id=dbg style="position:fixed;right:0;top:32px;"></pre>


<script>
testtree = {title:"Root", children:[
  {
    title: "Test note one",
    x: 80,
    y: 60,
    width: 150,
    height: 50,
    color: {h: 50, s:100, l:50},
    children: []
  },
  {
    title: "Test note two",
    x: 130,
    y: 140,
    width: 150,
    height: 50,
    color: {h: 10, s:100, l:50},
    children: [],

    // optional properties:
    id:1,
    open:false,
    view:{x:0,y:0,s:1},
    lines:[],
    pinned: 0,
  }
]}

if (localStorage.tree) tree=JSON.parse(localStorage.tree);

if (!window.tree){
  tree=testtree;
  localStorage.tree = JSON.stringify(tree)
}

window.onstorage=(e)=>{
  if (document.hasFocus()) return;
  tree=JSON.parse(localStorage.tree); 
  reloadAll()
}

var level;
var canvas=document.getElementById('canvas')
var menu=document.getElementById('menu')
var main=document.getElementById('main')
var trail=document.getElementById('trail')
var outline=document.getElementById('outline')
var sidebarLeft=document.getElementById('sidebarLeft')
var sidebarLeftAdj=document.getElementById('sidebarLeftAdj')
var searchInput=document.getElementById('searchInput')
var help=document.getElementById('help')
var toolbox=document.getElementById('toolbox')
var marquee=document.getElementById('marquee')
var selection={elements:[],objects:[]};
var trailobj=[]
var menuRef=null;
var menuRefElement=null;
var zTopIndex = 0;
var penSmooth = 0.15;
var offsetLeft = 0;
var textEditing=false;
var deltaHistory=[], redoHistory=[];

function openHelp(){
  help.style.display='block'
}
function closeHelp(){
  help.style.display='none'
}
var sidebarLeftSize=200;
function setOffset(ol){
  sidebarLeftSize=offsetLeft=ol;
  ol+='px';
  canvas.style.left=ol;
  sidebarLeft.style.width=ol
}
function toggleSidebarLeft(){
  canvas.style.transition='0.2s'

  if (offsetLeft) {
    sidebarLeft.style.left=-offsetLeft + "px"
    canvas.style.left="0px"
    offsetLeft = 0;
  } else {
    offsetLeft=sidebarLeftSize
    sidebarLeft.style.visibility="visible"
    sidebarLeft.style.left="0px"
    canvas.style.left=offsetLeft+'px'
  }

  setTimeout(function(){
    sidebarLeft.style.visibility=offsetLeft?"visible":"hidden"
    canvas.style.transition=''
  },200)
}
function deleteNote(){
  menuAction(function(n, el){
    delete noteElementsById[n.id];
    noteParentById[n.id].children.splice( noteParentById[n.id].children.indexOf(n), 1 )
  })

  reGenLookups()
  populate(level)
  rePopulateOutline()
}
function changeColor(){
  menu.style.display='none';

  let c = hex2hsl(document.getElementById('notecolor').value);

  if (selection.elements.length) {
    let d=[]
    for (let i=0; i<selection.elements.length; i++) {
      d.push(deltaAction({action:"setColor",id:selection.objects[i].id,color:c}))
    }
    deltaPushRaw(d)
    //if (fn==togglePinned) clearSelection()
  } else {
    deltaPush({action:"setColor",id:menuRef.id,color:c})
  }

}
function moveUpNote(){
  menu.style.display='none';
  if (trailobj.length<=1) {
    if (!confirm("Create new note above root?")) return;
    tree.x=50 //todo: check it doesn't collide with menuref
    tree.y=50
    tree.width=200
    tree.height=200
    tree.color={h:0,s:0,l:100}
    tree.title="Old root"
    tree = {title:"Root", children:[tree]}
    trailobj.unshift(tree)
  }
  let parent=trailobj[trailobj.length-2];
  menuAction(function(n,el){
    parent.children.push(n);
    level.children.splice(level.children.indexOf(n),1)
  })

  reGenLookups()
  showNote(parent.id)
  rePopulateOutline()
}
function editNote(){
  menu.style.display='none';
  menuRefElement.ondblclick()
}
function jumpInto(){
  menu.style.display='none';
  menuRefElement.oncontextmenu()
}
function menuAction(fn) {
  menu.style.display='none';
  if (selection.elements.length) {
    for (let i=0; i<selection.elements.length; i++) {
      fn(selection.objects[i], selection.elements[i])
    }
    if (fn==togglePinned) clearSelection()
  } else {
    fn(menuRef, menuRefElement)
  }
  save()
}
function toggleStrike(n, el){
  let [a, h, b] = n.title.match(/^(#+)?([\s\S]+)$/)
  if (!h) h="";
  let m = b.match(/^~([\s\S]+)~$/)
  if (m){
    n.title=h+m[1];
  } else {
    n.title=h+'~'+b+'~'
  }
  updateOutlineLink(n)
  el.children[1].innerHTML = markdown(n.title)
}
function togglePinned(n, el){
  if (n.pinned) {
    n.pinned = 0
    el.classList.remove("pinned")
  } else {
    n.pinned = 1
    el.classList.add("pinned")
  }
}
function eraseAllLines(){
  delete level.lines;
  save()
  populate(level)
}
function killEvent(e){e.preventDefault();e.stopPropagation()}
function backgroundKillEvent(e){
  if (background(e.target)) {e.preventDefault();e.stopPropagation()}
}
function setNoteColor(n,d) {
  if (n.color.l==0){
    d.classList.add("invis")
  } else {
    d.style.backgroundColor='hsl('+n.color.h+','+n.color.s+'%,'+n.color.l+'%)';
    d.style.borderColor='hsl('+n.color.h+','+n.color.s+'%,'+(n.color.l*0.8)+'%)';
  }
}
function createNote(n, editImmediately=false){
  var d = document.createElement('div');
  d.className='note'
  
  setNoteColor(n,d)
  if (n.pinned) d.classList.add("pinned")

  d.style.width=n.width+'px'
  d.style.height=n.height+'px'
  d.style.left=n.x+'px'
  d.style.top=n.y+'px'

  var a = document.createElement('div');
  a.className='gear'
  a.onclick=function(e){
    e.stopPropagation(); e.preventDefault()
    if (e.clientX>window.innerWidth-220){
      menu.style.left=''
      menu.style.right=window.innerWidth-e.pageX +'px'
    } else {
      menu.style.left=e.pageX+'px'
      menu.style.right=''
    }
    if (e.clientY>window.innerHeight-220){
      menu.style.top=''
      menu.style.bottom=window.innerHeight-e.pageY +'px'
    } else {
      menu.style.top=e.pageY+'px'
      menu.style.bottom=''
    }
    
    menu.style.display='block'
    document.getElementById('notecolor').value=hsl2rgb(n.color.h,n.color.s,n.color.l)
    document.getElementById('jumpInto').href='#'+n.id;
    menuRef=n;
    menuRefElement=d;
  }
  a.ondblclick=killEvent;
  d.appendChild(a)

  var t = document.createElement('div');
  t.innerHTML=markdown(n.title)
  d.appendChild(t)

  d.ondblclick=function(ev){
    if (ev && ev.target.tagName=='TEXTAREA') return;
    var e = document.createElement('textarea')
    function saveText(){
      deltaPush({action:"setTitle", id:n.id, title:e.value})
      t.innerHTML = markdown(n.title);
      d.style.overflow='auto';
      updateOutlineLink(n)
      setTimeout(()=>textEditing=false,100)
    }

    e.textContent = n.title
    e.style.width = (n.width-8)+'px'
    e.style.height = (n.height-8)+'px'
    e.style.background = n.color.l==0?'transparent':'hsl('+n.color.h+','+n.color.s+'%,'+n.color.l*1.2+'%)';
    t.innerHTML = "";
    d.style.overflow='visible'
    t.appendChild(e);
    textEditing=true;

    e.focus()
    if (n.title=="New note") e.select()
    e.onblur=saveText;
    e.onkeydown=function(e){
      e.stopPropagation()
      if (((e.keyCode==13 || e.keyCode==10) && e.ctrlKey) || e.keyCode==27)
        saveText();
    }
  }

  d.oncontextmenu = function(e){
    if (document.onmouseup!=null) return false;
    if (e && e.target.tagName=='TEXTAREA') return;
    d.style.transition="0.3s linear"
    
    d.style.left=(window.innerWidth -n.width )/2 + 'px'
    d.style.top=(window.innerHeight -n.height)/2  + 'px'
    d.style.transform="scale("+(window.innerWidth/n.width)*1.2+")"
    d.style.zIndex=++zTopIndex;
    main.style.opacity='0'
    mainSvg.style.opacity='0'
    menu.style.display='none'
    document.body.style.backgroundColor='';
    d.onmousedown=null
    d.ondblclick=null
    d.oncontextmenu=null

    setTimeout(()=>{
      main.style.opacity=''
      mainSvg.style.opacity=''
      trailobj.push(n)
      regenTrail()
      populate(n)
    },300)

    return false;
  }

  d.onmousedown=function(e){
    if (e.target.tagName=="TEXTAREA" || e.button!=0 || n.pinned || penTool=="zoom" || penTool=="hand") return;
    var sw = d.style.width, sh = d.style.height;
    d.style.zIndex = ++zTopIndex

    var targets=selection;
    if (selection.elements.indexOf(d)==-1) {
      clearSelection();
      targets={elements:[d],objects:[n]}
    }

    var startx=n.x, starty=n.y;
    var [sx, sy] = mousePos(e);
    let suppressJump = mostOverlapping(n)[1]>0;

    let undoAction =[];
    for (let n of targets.objects) {
      undoAction.push({action:"setLayout", id:n.id, x:n.x,y:n.y,width:n.width,height:n.height})
    }

    d.style.cursor='move'

    document.onmousemove=function(e){
      if (d.style.width!=sw || d.style.height!=sh) {
        n.width = parseFloat(d.style.width)
        n.height= parseFloat(d.style.height)
        return
      }

      let [mx, my] = mousePos(e);
      let dx = mx - sx, dy = my - sy;
      sx=mx; sy=my;

      for (let i=0; i<targets.elements.length; i++) {
        moveNote(targets.objects[i], targets.elements[i],dx,dy)
      }
      let [m, ma] = mostOverlapping(n);
      for (let i of main.children){ i.classList.remove('hl')}
      if (ma>0) {
        if (!suppressJump) main.children[m].classList.add('hl');
      } else suppressJump=false;
    }
    document.onmouseup=function(){
      document.onmouseup=null;
      document.onmousemove=null;
      d.style.cursor='';

      if (d.style.width!=sw || d.style.height!=sh) {
        deltaPushRaw(undoAction)
        return
      }
      
      let [m, ma] = mostOverlapping(n);
      if (ma>0 && !suppressJump) {
        let p = targets.elements.length>1?"group":'"'+shortTitle(n.title)+'"';
        let target = level.children[m];

        if (confirm('Move '+p+' into "'+shortTitle(target.title)+'"?')) {
          if (target.children.length==0) target.open=true
          let dx = n.x-startx, dy = n.y-starty;

          for (let i=0; i<targets.elements.length; i++) {
            sendNoteInto(targets.objects[i], targets.elements[i], target, dx,dy)
          }
          save()
          reGenLookups()

          setTimeout(()=>{populate(level); rePopulateOutline()},300)
        } else {
          suppressJump = true;
          main.children[m].classList.remove('hl')
        }
      }

      if (n.x!=startx || n.y !=starty) {
        deltaPushRaw(undoAction)
      }
    }
  }

  let bound = {w:window.innerWidth,h:window.innerHeight}
  let scale = Math.min(0.9*n.width/bound.w, 0.9*n.height/bound.h) || 0.1;
  
  if (n.lines){
    let container = document.createElement("div")
    let svg = document.createElementNS(svgNS, "svg");
    setSVGsize(svg,bound.w,bound.h)
    for (let line of n.lines) addSVGline(svg, line)
    svg.style.transform='scale('+scale+')'
    container.appendChild(svg)
    container.style.position='absolute'
    container.style.left='0'
    container.style.bottom=bound.h*scale+'px'
    d.appendChild(container)
  }

  for (let i of n.children) {
    let sn = document.createElement('div')
    sn.className='subnote'
    let lighter = i.color.l*0.5 + 50;
    sn.style.backgroundColor='hsl('+i.color.h+','+i.color.s+'%,'+lighter+'%)';
    sn.style.borderColor='hsl('+i.color.h+','+i.color.s+'%,'+(lighter*0.8)+'%)';

    sn.style.width=i.width*scale+'px'
    sn.style.height=i.height*scale+'px'
    sn.style.left=i.x*scale+'px'
    sn.style.bottom=(bound.h-i.y-i.height)*scale+'px'

    d.appendChild(sn)
  }

  main.appendChild(d)
  noteElementsById[n.id]=d;
  if (editImmediately) d.ondblclick()
}
function moveNote(n,d,dx,dy) {
  n.x += dx
  n.y += dy
  d.style.left = n.x +'px'
  d.style.top  = n.y +'px'
}
function sendNoteInto(n,d,target,dx,dy) {
  target.children.push(n)
  level.children.splice(level.children.indexOf(n), 1)
  n.x -= dx
  n.y -= dy
  d.style.transition="0.3s linear"
  d.style.transform="scale(0)"
}
function zoomReset(){
  level.view={x:0,y:0,s:1}
  setView()
  saveWithoutHistory()
}
function zoomFit(){
  if (level.children.length==0 && (!level.lines || level.lines.length==0) ) return;

  let maxx=-Infinity, maxy=-Infinity, minx=Infinity, miny=Infinity;
  for (let c of level.children) {
    if (c.x<minx) minx=c.x;
    if (c.y<miny) miny=c.y;
    if (c.x+c.width > maxx) maxx=c.x+c.width;
    if (c.y+c.height > maxy) maxy=c.y+c.height;
  }
  if (level.lines) for (let line of level.lines) {
    for (let p of line.points) {
    if (p[0]<minx) minx=p[0];
    if (p[1]<miny) miny=p[1];
    if (p[0]>maxx) maxx=p[0];
    if (p[1]>maxy) maxy=p[1];
    }
  }
  let margin = 10;
  maxx += margin
  maxy += margin
  minx -= margin
  miny -= margin

  let ww= window.innerWidth-offsetLeft,
      wh= window.innerHeight;

  let s1= ww/(maxx-minx),
      s2= wh/(maxy-miny);
  if (s1<s2){
    level.view.s = s1
    level.view.x = -minx*s1
    level.view.y = -miny*s1 + (wh-(maxy-miny)*s1)/2
  } else {
    level.view.s = s2
    level.view.y = -miny*s2
    level.view.x = -minx*s2 + (ww-(maxx-minx)*s2)/2
  }
  setView()
  saveWithoutHistory()
}
function setView(){
  if (!level.view) level.view={x:0,y:0,s:1}
  mainSvgG.style.transform = 
  main.style.transform=`translate(${level.view.x}px, ${level.view.y}px) scale(${level.view.s})`
}
function mousePos(e) {
  return [
    (e.pageX-level.view.x-offsetLeft)/level.view.s,
    (e.pageY-level.view.y           )/level.view.s ]
}
function removeAllChildNodes(a){
  while (a.children.length)
    a.removeChild(a.lastChild)
}
function populate(t){
  if (window.location.hash!='#'+t.id)
    window.history.pushState({},'','#'+t.id) //or maybe replaceState

  document.title = shortTitle(t.title,1,1) +` [${t.id}] - recursive`;

  zTopIndex=0
  removeAllChildNodes(main)
  noteElementsById={}
  for (let i of t.children)
    createNote(i)
  level = t
  setView()

  while(mainSvgG.children.length)
    mainSvgG.removeChild(mainSvgG.lastChild)
  if (t.lines) {
    for (let line of t.lines) addSVGline(mainSvgG, line)
  }
  document.body.style.backgroundColor= t.color? 'hsl('+t.color.h+','+t.color.s+'%,'+(t.color.l*0.3+70)+'%)' : '#fff';
}
function showNote(id){
  trailobj=[]
  let p=noteById[id];
  while (p) {
    trailobj.unshift(p)
    p=noteParentById[p.id]
  }
  regenTrail()
  populate(noteById[id])
}
function regenTrail(){
  let s=[]
  for (let i in trailobj) {
    let n=trailobj[i], c1="#fff", c2="#ccc"
    if (n.color && n.color.l!=0){
      c1 = "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l+"%)"
      c2 = "hsl("+n.color.h+','+n.color.s+'%,'+n.color.l*0.8+"%)"
    }
    let a=document.createElement('a')
    a.textContent=shortTitle(n.title, i==trailobj.length-1,1)
    a.href='#'+n.id
    a.style.background=c1;
    a.style.borderColor=c2;
    makeDropTarget(a, n)
    s.push(a)
  }

  removeAllChildNodes(trail)
  for (let i=s.length;i--;) {
    trail.append(s[i])
    if (i) trail.append(document.createTextNode(" \u2794 "))
  }
}
function shortTitle(t, last, noescape){
  let maxlength = last ? 50:20;

  if (!t) return "(no name)"
  t = t.split("\n")[0].replace(/^[#]+/,"").replace(/~/g,"");
  
  if (t.length>maxlength+3) t=t.slice(0,maxlength)+"..."
  return noescape?t:escapeEntities(t);
}
function background(t){
  return mainSvg.contains(t)
}
function pannableTarget(t){
  return main.contains(t) || mainSvg.contains(t)
}
document.onclick=function(e){
  if (textEditing || !background(e.target))return;
  if (penTool=="none") clearSelection()
  if (penTool!="addnote") return;
  clearSelection()
  let [mx, my] = mousePos(e);
  var newNote = {
    id: newId(),
    title: "New note",
    x: mx,
    y: my,
    width: 200,
    height: 50,
    color: randomColor(),
    children: []
  }
  if (level.children.length==0) level.open=true;
  createNote(newNote, true)
  level.children.push(newNote)
  save()
  noteById[newNote.id]=newNote;
  noteParentById[newNote.id]=level;
  rePopulateOutline()
}
menu.onmousedown=function(e){e.stopPropagation()}

var cursorStack=[];
function pushCursor(c){
  cursorStack.push(c)
  setCursor(c)
}
function popCursor(){
  cursorStack.pop()
  let c = cursorStack.length? cursorStack[cursorStack.length-1] :"";
  setCursor(c)
}
function setCursor(c){
  if (c=="grab" || c=="grabbing" || c=="zoom-in") main.classList.add("panning")
  else main.classList.remove("panning")
  main.style.cursor=c;
  mainSvg.style.cursor=c;
}
function selectAll(){
  selection.elements=[];
  selection.objects=[];
  for (let i=0;i<level.children.length;i++) {
    let c=level.children[i];
    if (c.pinned) continue;
      selection.objects.push(c)
      selection.elements.push(main.children[i])
      main.children[i].classList.add('selected')
  }
}
function clearSelection(){
  for (let e of selection.elements) {
    e.classList.remove('selected')
  }
  selection.elements=[];
  selection.objects=[];
}
function drawMarquee(x1,y1,x2,y2, existing) {
  let x,y,w,h, partial=true;
  if (x2<x1) {x=x2; w=x1-x2} else {x=x1; w=x2-x1; partial=false}
  if (y2<y1) {y=y2; h=y1-y2} else {y=y1; h=y2-y1}

  let lx = (x-level.view.x-offsetLeft)/level.view.s,
      ly = (y-level.view.y)/level.view.s,
      lw = w/level.view.s,
      lh = h/level.view.s;

  selection.elements=[];
  selection.objects=[];

  if (partial) {
    function withinMarquee(c) {
      return c.x<lx+lw
          && c.x+c.width>lx
          && c.y<ly+lh
          && c.y+c.height>ly;
    }
  } else {
    function withinMarquee(c) {
      return c.x>lx
          && c.y>ly
          && c.x+c.width<lx+lw
          && c.y+c.height<ly+lh;
    }
  }

  for (let i=0;i<level.children.length;i++) {
    let c=level.children[i];
    if (c.pinned) continue;
    if (withinMarquee(c) || existing.indexOf(c)!=-1) {
        selection.objects.push(c)
        selection.elements.push(main.children[i])
        main.children[i].classList.add('selected')
    } else main.children[i].classList.remove('selected')
  }

  marquee.style.left=x+'px'
  marquee.style.top=y+'px'
  marquee.style.width=w+'px';
  marquee.style.height=h+'px';
}
document.onmousedown=function(e){
  menu.style.display='none'
  if (document.onmouseup && penTool!="hand") return;
  if (e.target.tagName=="TEXTAREA" && e.button!=1) return;
  var b = e.button;

  if (e.target==sidebarLeftAdj){
    setOffset(e.clientX+4)
    document.onmousemove=function(e){
      setOffset(e.clientX+4)
    }
    document.onmouseup=function(e){
      document.onmouseup=null;
      document.onmousemove=null;
    }
  }

  if (penTool=="hand" || e.button==1) { // middle click
    if (!pannableTarget(e.target)) return
    if (e.button==1) killEvent(e);
    let sx = e.pageX, sy = e.pageY;
    document.onmousemove=function(e){
      level.view.x+= (e.pageX-sx)
      level.view.y+= (e.pageY-sy)
      sx = e.pageX, sy = e.pageY;
      setView()
    }
    document.onmouseup=function(e){
      if (e.button !=b) return;
      document.onmouseup=null;
      document.onmousemove=null;
      saveWithoutHistory()
      popCursor()
    }
    pushCursor('grabbing')
    return;
  }
  if (penTool=="zoom"){
    if (!pannableTarget(e.target)) return
    let sx = e.pageX, sy = e.pageY, cx=sx, cy=sy;
    document.onmousemove=function(e){
      doZoom( (e.pageX-sx) + (e.pageY-sy), cx, cy)
      sx = e.pageX, sy = e.pageY;
    }
    document.onmouseup=function(e){
      if (e.button !=b) return;
      document.onmouseup=null;
      document.onmousemove=null;
      saveWithoutHistory()
    }
    return;
  }
  if (textEditing || !background(e.target)) return;

  if (penTool=="marquee"){
    let sx = e.pageX, sy=e.pageY;
    let existing = e.shiftKey?selection.objects:[];
    drawMarquee(sx,sy,sx,sy, existing)
    marquee.style.display='block'
    document.onmousemove=function(e){
      drawMarquee(sx,sy,e.pageX,e.pageY, existing)
    }
    document.onmouseup=function(e){
      marquee.style.display='none';
      document.onmouseup=null;
      document.onmousemove=null;
    }
    return;
  }

  let [sx, sy] = mousePos(e);

  if (penTool=="none" || penTool=="addnote") return;
  if (penTool=="erase" || e.button==2) {

    document.onmousemove=function(e){
      if (e.target.tagName!="path") return;
      let i;
      for (i in mainSvgG.children)
        if (mainSvgG.children[i] == e.target) break
      level.lines.splice(i,1)
      e.target.remove()
      save()
    }
    document.onmouseup=function(e){
      if (e.button !=b) return;
      document.onmousemove=null;
      popCursor()
      setTimeout(()=>{
        document.onmouseup=null;
      },1);
    }
    pushCursor(cursors['erase'])

  } else { // draw a line of some sort
    var line = {points:[[sx,sy]]}, path=null;
    if (!level.lines) level.lines=[]
    level.lines.push(line)
    if (penTool=="arrow" && arrowStyle < 3) {line.fill=penColor}
    if (penWidth!="3px") line.width=penWidth;
    if (penColor!="black") line.color=penColor;

    path=addSVGline(mainSvgG, line)

    document.onmouseup=function(e){
      if (e.button !=b) return;
      document.onmousemove(e)
      document.onmouseup=null;
      document.onmousemove=null;
      save();
    }

    if (penTool=="pencil") {
      document.onmousemove=function(e){
        line.points.push(mousePos(e))
        updateSVGline(path,line)
      }
    } else if (penTool=="line") {
      document.onmousemove=function(e){
        line.points = [[sx,sy],mousePos(e)]
        updateSVGline(path,line)
      }
    } else if (penTool=="arrow") {
      line.smooth=0
      document.onmousemove=function(e){
        let [mx, my] = mousePos(e)
        line.points = drawArrow( sx, sy, mx, my )
        updateSVGline(path,line)
      }
    } else if (penTool=="rect") {
      line.smooth=0
      document.onmousemove=function(e){
        let [mx, my] = mousePos(e)
        line.points = [
          [sx, sy],
          [mx, sy],
          [mx, my],
          [sx, my],
          [sx, sy], // go round again to enforce a sharp corner on chrome
          [mx, sy]
        ]
        updateSVGline(path,line)
      }
    }
  }
}
function drawArrow(x1,y1,x2,y2){
  let dx = x2-x1, dy = y2-y1, len = Math.sqrt(dx*dx+dy*dy);
  let h = Math.min(arrowSize,500*arrowSize*arrowSize/len);
  dx*=h
  dy*=h
  let dx2 = dx*1.73205; // 2*cos(30deg)
  let dy2 = dy*1.73205;
  switch (arrowStyle) {
  case "1": case "3": return [ // ⯈
    [x1,y1],
    [x2    -dx2,y2    -dy2],
    [x2 -dy-dx2,y2 +dx-dy2],
    [x2        ,y2 ],
    [x2 +dy-dx2,y2 -dx-dy2],
    [x2    -dx2,y2    -dy2]]  
  case "2": case "4": return [ // ➤
    [x1,y1],
    [x2-dx*0.99,y2-dy*0.99],
    [x2     -dx,y2    -dy],
    [x2 -dy-dx2,y2 +dx-dy2],
    [x2        ,y2 ],
    [x2 +dy-dx2,y2 -dx-dy2],
    [x2     -dx,y2    -dy]]
  default: return [            // ᐳ
    [x1,y1],
    [x2 -dx*0.0099,y2 -dy*0.0099],
    [x2 -dx*0.01,  y2 -dy*0.01],
    [x2 -dy-dx*1.2,y2 +dx-dy*1.2],
    [x2           ,y2 ],
    [x2 +dy-dx*1.2,y2 -dx-dy*1.2],
    [x2 -dx*0.01,  y2 -dy*0.01]]
  }
}
document.onwheel=function(e){
  if (sidebarLeft.contains(e.target) || help.contains(e.target)) return;
  menu.style.display='none'

  doZoom(e.deltaY, e.pageX, e.pageY)

  saveWithoutHistory()
}
window.onhashchange = function(){
  let i = location.hash.substr(1);
  if ( i && noteById.hasOwnProperty(i) ) {
    showNote(i)
  } else {
    // load root
    window.history.replaceState({},'','#'+tree.id)
    showNote(tree.id)
  }
}

{ // touch support
  let tsx={}, tsy={}, td=0, tcx=0,tcy=0;
  function fakeMouse(type, t){
    if (penTool=="none" || penTool=="hand" || penTool=="zoom") return false;
    (penTool=="erase"?document.elementFromPoint(t.pageX,t.pageY):t.target)
      .dispatchEvent(new MouseEvent(type, {
          bubbles:true,
          button:0,
          buttons:0,
          clientX:t.clientX,
          clientY:t.clientY,
          pageX:t.pageX,
          pageY:t.pageY,
        }))
    return true
  }
  document.addEventListener("touchstart", function(e){
    let t=e.changedTouches[0], id=t.identifier;
    tsx[id]=t.clientX;
    tsy[id]=t.clientY;
    
    if (e.touches.length>1) {
      td = touchdistance(e.touches[0],e.touches[1]);
      tcx = (e.touches[0].clientX+e.touches[1].clientX)/2;
      tcy = (e.touches[0].clientY+e.touches[1].clientY)/2;
    } else {
      if (pannableTarget(e.target))
        fakeMouse("mousedown",e.touches[0]);
    }
  }, true);
  document.addEventListener("touchmove", function(e){
    if (e.target==sidebarLeftAdj && e.touches.length==1) {
      setOffset(e.touches[0].clientX+4)
      return;
    }
    if (!pannableTarget(e.target)) return;
    e.preventDefault()
    e.stopPropagation()

    if (fakeMouse("mousemove",e.touches[0])) return;

    if (e.touches.length==1){
      let t=e.touches[0];
  
      level.view.x +=(t.clientX-tsx[t.identifier])
      level.view.y +=(t.clientY-tsy[t.identifier])
    
    } else {
      let ntcx = (e.touches[0].clientX+e.touches[1].clientX)/2;
      let ntcy = (e.touches[0].clientY+e.touches[1].clientY)/2;
      let ntd = touchdistance(e.touches[0],e.touches[1])
  
      let sx= (ntcx -level.view.x -offsetLeft)/level.view.s;
      let sy= (ntcy -level.view.y            )/level.view.s;
      
      level.view.s *= ntd/td
      
      level.view.x = -sx*level.view.s + ntcx + (ntcx-tcx) -offsetLeft
      level.view.y = -sy*level.view.s + ntcy + (ntcy-tcy)
  
      td = ntd
      tcx = ntcx
      tcy = ntcy
    }
  
    for (let i=0;i< e.changedTouches.length;i++) {
      tsx[e.changedTouches[i].identifier]=e.changedTouches[i].clientX;
      tsy[e.changedTouches[i].identifier]=e.changedTouches[i].clientY;
    }
    setView()
  }, {capture:true, passive:false});
  document.addEventListener("touchend", function(e){
    if (e.touches.length==0) {
      if (fakeMouse("mouseup",e.changedTouches[0])) return;
      saveWithoutHistory()
    }
  }, true);
  function touchdistance(t1,t2){
    return Math.sqrt((t1.clientX-t2.clientX)*(t1.clientX-t2.clientX) + (t1.clientY-t2.clientY)*(t1.clientY-t2.clientY))
  }
}

function escapeEntities(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
}
function markdownApply(s){
  let lines = s.replace(/</g,'&lt;').replace(/>/g,'&gt;').split("\n") //ampersand may occur in url
  let links=[]
  let namedlinks=[]
  let codes=[]
  let images=[]
  let list = [], indentstack=[];
  for (let i in lines){
    let indent=0, listtag="ul>";
    lines[i]=lines[i]
      .replace(/`([^`]+)`/g,function(m, p1){
        codes.push(p1)
        return "<PRECODE>"; //first replace ensures this won't be present
      })
      .replace(/!\[([^\]]+)\]\(([^\)]+)\)/g,function(m, p1, p2){
        images.push([p1,p2])
        return "<IMAGES>";
      })
      .replace(/\[([^\]]+)\]\(([^\)]+)\)/g,function(m, p1, p2){
        namedlinks.push([p1,p2])
        return "<NAMEDLINK>";
      })
      .replace(/(http|ftp|https):\/\/([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:\/~*+#-]*[\w@?^=%&\/~*+#-])?/gi,function(match){
        links.push(match)
        return "<LINK>";
      })
      .replace(/^([ ]*)[-\*] (.+)$/, function(m,p1,p2){
        indent=p1.length+1;
        listtag="ul>";
        return "<li>"+p2
      })
      .replace(/^([ ]*)[0-9]{1,2}\. (.+)$/, function(m,p1,p2){
        indent=p1.length+1;
        listtag="ol>";
        return "<li>"+p2
      })
      //.replace(/&(?!lt;|gt;)/g,'&amp;')
      .replace(/^([#]+)(.+)$/,function(m, p1, p2){
        if (p1=='#') return '<h3>'+p2+'</h3>'
        if (p1=='##') return '<h2>'+p2+'</h2>'
        return '<h1>'+p2+'</h1>'
      });

      if (indent && (indentstack.length==0 || indentstack[0]<indent)) { // indent increased, can only increase by one at a time
        indentstack.unshift(indent)
      } else while (indentstack.length && indent != indentstack[0]){ // indent must have dropped, by one or more
        indentstack.shift()
      }

      while (list.length<indentstack.length) lines[i]="<"+listtag+lines[i],list.push("</"+listtag);
      while (list.length>indentstack.length) lines[i]=list.pop()+lines[i];
  }
  return lines.join("<br>")
        .replace(/_([^_]+)_/g,'<i>$1</i>')
        .replace(/\*([^\*]+)\*/g,'<b>$1</b>')
        .replace(/~([^~]+)~/g,'<s>$1</s>')
        .replace(/<PRECODE>/g,function(m){
          return "<code>"+codes.shift()+"</code>";
        })
        .replace(/<LINK>/g,function(m){
            let l = links.shift()
            return "<a href='"+l+"' rel='noreferrer noopener' target=_blank>"+l+"</a>"
        })
        .replace(/<NAMEDLINK>/g,function(m){
            let [t,l] = namedlinks.shift()
            return "<a href='"+l+"' rel='noreferrer noopener' target=_blank>"+t+"</a>"
        })
        .replace(/<IMAGES>/g,function(m){
            let [alt, src] = images.shift()
            return `<img onmousedown='return false' src="${src}" alt="${alt}">`
        })
}
function markdown(s){
  //separate out preformatted areas first
  let pre = s.replace(/[\n]?```[\n]?/g,'```').split('```')
  for (let i = 0; i<pre.length; i++) {
    if (i%2) pre[i]="<pre>"+escapeEntities(pre[i])+"</pre>"
    else pre[i] = markdownApply(pre[i])
  }
  return pre.join("\n")
}
function autoIndex(n){
  return Math.round(Math.sqrt(n.x*n.x +n.y*n.y))
}
function areaOfOverlap(a,b){
  let h = Math.min(Math.max(0,Math.min(a.x+a.width-b.x, b.x+b.width-a.x)),a.width,b.width);
  let v = Math.min(Math.max(0,Math.min(a.y+a.height-b.y, b.y+b.height-a.y)),a.height,b.height);
  return h*v // / Math.min(a.width*a.height, b.width*b.height)
}
function mostOverlapping(n){
  let m, ma=0;
  for (let i in level.children){
    if (n==level.children[i]) continue;
    if (level.children[i].pinned) continue;
    let a=areaOfOverlap(n,level.children[i])
    if (a>ma) {ma=a; m=i}
  }
  return [m, ma]
}
function clamp(i){
  if (i>1) return 1;
  if (i<0) return 0
  return i
}
function yiq2hsl(y, i, q) {
  let r = clamp((y + ( 0.956 * i) + ( 0.621 * q)) );
  let g = clamp((y + (-0.272 * i) + (-0.647 * q)) );
  let b = clamp((y + (-1.105 * i) + ( 1.702 * q)) );
  return rgb2hsl(r,g,b)
}
function hex2hsl(c){
  c = c.match(/[a-z0-9]{2}/gi)
  return rgb2hsl( parseInt(c[0],16)/255, parseInt(c[1],16)/255, parseInt(c[2],16)/255 );
}
function rgb2hsl(r,g,b) {
  let min = Math.min( r, g, b );
  let max = Math.max( r, g, b );
  l = (max+min)*50;
  if (max==min) return {h:0,s:0,l};

  let d = max - min;
  s = l > 50 ? d / (2 - max - min) : d / (max + min);
  switch(max){
    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
    case g: h = (b - r) / d + 2; break;
    case b: h = (r - g) / d + 4; break;
  }
  h *= 60;
  s *=100;

  return {h,s,l}
}
function hue2rgb(p, q, t){
  if(t < 0) t += 1;
  if(t > 1) t -= 1;
  if(t < 1/6) return p + (q - p) * 6 * t;
  if(t < 1/2) return q;
  if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
  return p;
}
function hsl2rgb(h, s, l){
  var r, g, b;
  h/=360;
  s/=100;
  l/=100;

  if(s == 0){
    r = g = b = l;
  }else{
    var q = l <= 0.5 ? l * (1 + s) : l + s - l * s;
    var p = 2 * l - q;
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }
  return '#'+hex(r)+hex(g)+hex(b);
}
function hex(s){
  return ('00'+Math.round(s * 255).toString(16)).substr(-2,2);
}
var sColor=Math.random()*3.14159
function randomColor(){
  let angle = sColor+=1.3 // Math.random()*2*3.1415926535;
  return yiq2hsl( 0.8, 0.5*Math.cos(angle), 0.5*Math.sin(angle) );
}

function save(){
  dbg.innerHTML='Undo:'+JSON.stringify(deltaHistory,' ',2)+'\nRedo:'+JSON.stringify(redoHistory,' ',2)
  localStorage.tree=JSON.stringify(tree)
}
function saveWithoutHistory(){
  localStorage.tree=JSON.stringify(tree)
}
function deltaPush(a){
  deltaHistory.push(deltaAction(a))
  redoHistory=[];
  save()
}
function deltaPushRaw(a) {
  deltaHistory.push(a)
  redoHistory=[]
  save()
}
function undo(){
  traverseHistory(deltaHistory, redoHistory)
}
function redo(){
  traverseHistory(redoHistory, deltaHistory)
}
function traverseHistory(from, to){
  var u = from.pop()
  if (!u) return

  if (Array.isArray(u)) {
    let r=[];
    for (let i of u) r.push(deltaAction(i));
    to.push(r)
  } else to.push(deltaAction(u))

  save()
  reloadAll() // remove later
}
function deltaAction(a){
  let undo = {id:a.id}, n=noteById[a.id];
  switch(a.action){
    case "setTitle":
      undo.action="setTitle";
      undo.title=n.title;
      n.title = a.title;
      // if note visible, update innerHTML
      // update outline link
    break;
    case "setLayout":
      undo.action="setLayout"
      undo.x = n.x
      undo.y = n.y
      undo.width = n.width
      undo.height = n.height
      n.x = a.x
      n.y = a.y
      n.width = a.width
      n.height = a.height
      // if note visible, or... note is within a child of level, update
    break;
    case "setColor":
      undo.action="setColor"
      undo.color = n.color
      n.color = a.color
      if (noteElementsById[n.id]) setNoteColor(n, noteElementsById[n.id])
    break;
  }
  return undo
}
function pan(dx,dy) {
  menu.style.display='none'
  level.view.x += dx;
  level.view.y += dy;
  setView()
  saveWithoutHistory()
}
function zoomCentred(s){
  doZoom(s, (window.innerWidth+offsetLeft)/2, window.innerHeight/2)
  saveWithoutHistory();
}
function doZoom(delta, cx, cy){
  let sx= (cx-level.view.x-offsetLeft)/level.view.s,
      sy= (cy-level.view.y           )/level.view.s;

  level.view.s*= Math.pow(10,delta*-0.001);

  level.view.x = -sx*level.view.s+cx-offsetLeft
  level.view.y = -sy*level.view.s+cy

  setView()
}
sidebarLeft.onkeydown=function(e){if (e.key!='/') e.stopPropagation()}
document.onkeydown=function(e){
  if (e.ctrlKey && e.key=='z') {undo(); return}
  if (e.ctrlKey && (e.key=='Z' || e.key=='y')) {redo(); return}
  if (e.ctrlKey && e.key=='a') {selectAll(); return}

  switch(e.key) {
    case 'ArrowLeft': pan(100,0); return;
    case 'ArrowUp':   pan(0,100); return;
    case 'ArrowRight':pan(-100,0); return;
    case 'ArrowDown': pan(0,-100); return;
    case 'PageDown': case '-': zoomCentred(100); return;
    case 'PageUp':   case '+': zoomCentred(-100); return;
    case 'Home': zoomReset(); return;
    case 'End': zoomFit(); return;
    case 't': setPenTool('addnote'); return;
    case 'm': setPenTool('marquee'); return;
    case 'b': setPenTool('pencil'); return;
    case 'l': setPenTool('line'); return;
    case 'a': setPenTool('arrow'); return;
    case 'r': setPenTool('rect'); return;
    case 'e': setPenTool('erase'); return;
    case 'h': setPenTool('hand'); return;
    case 'z': setPenTool('zoom'); return;
    case 's': toggleSidebarLeft(); return;
    case '/':
      if (document.activeElement==searchInput) return;
      killEvent(e);
      if (!offsetLeft) toggleSidebarLeft();
      searchInput.focus();
      return;
    case 'Escape':
      setPenTool('none');
      clearSelection();
      menu.style.display='none';
      return;
    case 'Delete':
      if (!selection.objects.length) return;
      for (let n of selection.objects) {
        delete noteElementsById[n.id];
        noteParentById[n.id].children.splice( noteParentById[n.id].children.indexOf(n), 1 )
      }
      save()
      reGenLookups()
      populate(level)
      rePopulateOutline()
      return;
  }
}
function setPenTool(newTool){
  if (document.onmouseup!=null) return;

  for (let t in toolButtons) toolButtons[t].classList.remove("active")
  if (toolButtons[newTool]) toolButtons[newTool].classList.add("active");

  if (penTool!=newTool) {
    if (cursors[penTool]) popCursor()
    if (cursors[newTool]) pushCursor(cursors[newTool])
  }
  penTool = newTool

  if (rightClickAction[penTool]) document.oncontextmenu=backgroundKillEvent;
  else document.oncontextmenu=null;
}
function downloadJson(){
  let blob = new Blob([JSON.stringify(tree)], {type: "application/json"})
  let url = URL.createObjectURL(blob)
  let a = document.createElement('a')
  a.href=url
  a.download="tree.json"
  document.body.appendChild(a);
  a.click()
  document.body.removeChild(a);
  URL.revokeObjectURL(url)
}

const mainSvg=document.querySelector('svg')
const mainSvgG=mainSvg.firstChild
const svgNS = "http://www.w3.org/2000/svg"
function setSVGsize(svg, w,h){
  svg.setAttribute("width",w)
  svg.setAttribute("height",h)
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`)
}
function addSVGline(svg, line){
  let path=document.createElementNS(svgNS, "path");
  path.setAttributeNS(null, "style", "stroke-width: "+(line.width||'3px')+"; fill: "+(line.fill||'none')+"; stroke: "+(line.color||'black'))
  path.setAttributeNS(null, "stroke-linecap", "round")
  if (!line.points.length) return;
  updateSVGline(path, line);
  svg.appendChild(path)
  return path
}
function updateSVGline(path, line){
  let pathstring = "M "+line.points[0].join(',')
  let smoothing = line.hasOwnProperty("smooth") ? line.smooth : penSmooth;
  if (smoothing) {

    let last = line.points.length -2;

    for (let i=0;i<line.points.length-1;i++) {
      let x0 = i==0? line.points[0][0] : line.points[i-1][0];
      let y0 = i==0? line.points[0][1] : line.points[i-1][1];

      let x1 = line.points[i][0];
      let y1 = line.points[i][1];
      let x2 = line.points[i+1][0];
      let y2 = line.points[i+1][1];

      let x3 = i==last? x2 : line.points[i+2][0];
      let y3 = i==last? y2 : line.points[i+2][1];

      let cp1x = x1 + (x2 - x0) * smoothing;
      let cp1y = y1 + (y2 - y0) * smoothing;
      let cp2x = x2 + (x1 - x3) * smoothing;
      let cp2y = y2 + (y1 - y3) * smoothing;

      pathstring += ` C${cp1x},${cp1y},${cp2x},${cp2y},${x2},${y2}`;
    }

  } else {
    for (let i=1;i<line.points.length;i++) pathstring += "L "+line.points[i].join(',')
  }
  path.setAttributeNS(null, "d", pathstring)
}
;(window.onresize=function(){
  setSVGsize(mainSvg, window.innerWidth,window.innerHeight);
})();

document.body.addEventListener('dragover', killEvent, false);
document.body.addEventListener('drop', function(e){
  e.stopPropagation();
  e.preventDefault();

  let files = e.dataTransfer.files;
  if (!files.length || files[0].name.indexOf(".json")==-1) return;

  let reader = new FileReader();
  reader.onload = function(e) {

    let newtree = JSON.parse(e.target.result);
    if (!validTree(newtree)) {alert("Invalid JSON data"); return }

    tree=newtree;
    save()
    reloadAll()
  }
  reader.readAsText(files[0])

},false);

// Todo: check IDs are unique
// check lines
// check view
// check color of root if present
function validTree(t){
  if (!t.title || !Array.isArray(t.children)) return false;
  for (let c of t.children){
    if (typeof c.width !=="number"
     || typeof c.height !=="number"
     || typeof c.x !=="number"
     || typeof c.y !=="number"
     || typeof c.color !=="object"
     || typeof c.color.l !=="number"
     || typeof c.color.h !=="number"
     || typeof c.color.s !=="number"
     || !validTree(c)
    ) return false
  }
  return true
}

var nextId = 0;
var allIds=[], noteById={}, noteParentById={}, noteElementsById={};

function findIds(ids, n) {
  if (n.id) ids.push(n.id)
  for (let c of n.children)
    findIds(ids,c)
}
function idInUse(id) {
  return (allIds.indexOf(id)!=-1)
}
function newId(){
  while (idInUse(nextId)) nextId++;
  allIds.push(nextId)
  return nextId
}
function genLookups(n) {
  if (!n.id) n.id = newId();
  noteById[n.id]=n;
  for (let c of n.children) {
    genLookups(c)
    noteParentById[c.id]=n
  }
}
function reGenLookups(){
  noteById={}
  noteParentById={}
  genLookups(tree)
  // should we set noteParentById[tree.id] to something?
}
function noteContains(haystack,needle){
  if (haystack==needle/* || haystack.children.indexOf(needle)!=-1*/) return true;
  for (c of haystack.children)
    if (noteContains(c,needle)) return true
  return false
}
function makeDropTarget(a, n) {
  a.ondrop=function(e){
    let data = e.dataTransfer.items;
    for (let i=0;i<data.length;i++) {
      if (data[i].kind === 'string' && data[i].type.match('^text/uri-list')) {
        data[i].getAsString(function(s) {
          s = s.split('#')
          if (s[0] != location.href.split('#')[0]) return;
          let moved = noteById[parseInt(s[1])];

          if (moved && !noteContains(moved, n) && confirm('Move "'+shortTitle(moved.title)+'" into "'+shortTitle(n.title)+'"?')){
            if (n.children.length==0) n.open=true
            n.children.push(moved)
            let from = noteParentById[moved.id].children
            from.splice( from.indexOf(moved), 1 )
            reGenLookups()
            save()
            showNote(level.id)
            rePopulateOutline()
          }
          a.className=''
        })
      }
    }
  }
  a.ondragenter=function(e){a.className='drop'}
  a.ondragleave=function(e){a.className=''}
}
var outlineLinksById=[];
function updateOutlineLink(n){
  let a = outlineLinksById[n.id];
  a.textContent=shortTitle(n.title,1,1)
  a.href='#'+n.id
  a.onclick=function(e){if (e.shiftKey) {location.href='#'+noteParentById[n.id].id; return false }}
  if (n.color && n.color.l) a.style.background='hsl('+n.color.h+','+n.color.s+'%,'+n.color.l+'%)';
  a.style.textDecoration= (n.title.match(/^[#]*~[^~]+~/))?'line-through':'';
}
function populateOutline(n,parent){

  let a=document.createElement('a');
  outlineLinksById[n.id]=a;
  updateOutlineLink(n)

  makeDropTarget(a, n)

  let p=document.createElement('p')

  if (n.children.length==0) {
    p.append(a)
    parent.append(p)
    return
  }

  let d=document.createElement('details')
  let s=document.createElement('summary')

  d.ontoggle=function(){n.open=d.open;saveWithoutHistory()}
  if (n.open) {d.setAttribute('open','')}

  s.append(a)
  d.append(s)
  d.append(p)
  parent.append(d)

  for (c of n.children)
    populateOutline(c,p)
}
function rePopulateOutline(){
  removeAllChildNodes(outline)
  outlineLinksById=[];
  if (!tree.hasOwnProperty('open')) tree.open=true;
  populateOutline(tree,outline)

  search(searchInput)
}
var searchResults=[], reverseSearchDirection=false;
searchInput.onkeydown=function(e){
  reverseSearchDirection=e.shiftKey
}
searchInput.onkeyup=function(e){
  if (e.key=='Shift') reverseSearchDirection=false;
}
function searchCheck(n,r){
  let el = outlineLinksById[n.id].parentNode;
  let match = r.test(n.title);
  if (match) {
    if (n.children.length || n==tree) searchResults.push(n.id);
    else searchResults.push(noteParentById[n.id].id);
  }

  for (let c of n.children)
    if (searchCheck(c,r)) match=true;

  el.className = match?"":"sresult";
  return match
}
function search(o){
  let r;
  try {
    r = new RegExp(o.value,'i');
  } catch(e) {
    r = new RegExp( escapeRegExp(o.value) ,'i');
  }
  searchResults=[];

  //todo: make async
  searchCheck(tree, r)

  searchResults=[...new Set(searchResults)] // remove duplicates
}
function jumpFirstSearch(){
  if (searchResults.length) {
    let p = searchResults.indexOf(level.id);
    if (reverseSearchDirection) p+=searchResults.length-2;
    showNote(searchResults[ (p+1)%searchResults.length ] );
  }
}
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
}

function reloadAll(){
  // Some notes may not have an id, but others further down the tree potentially could
  // Do two passes to make sure we don't assign an in-use id
  allIds=[]
  findIds(allIds,tree)
  nextId=Math.max(0,...allIds) +1;

  reGenLookups()

  rePopulateOutline()

  window.onhashchange()
}

var penTool = "none";
var penColor = document.getElementById('pencolor').value || "black";
var penWidth = document.getElementById('penwidth').value || "3px";
var arrowStyle = document.getElementById('arrowstyle').value || "3";
var arrowSize = document.getElementById('arrowsize').value/50 || 0.12;

var cursors={
  'hand':'grab',
  'pencil': 'url(icons/pencil.png) 2 21, crosshair',
  'erase': 'url(icons/erase.png) 5 20, crosshair',
  'marquee': 'crosshair',
  'line': 'crosshair',
  'arrow': 'crosshair',
  'rect': 'crosshair',
  'addnote': 'copy',
  'zoom':'zoom-in'
}
var toolTips={
  "addnote":"Add note [T]",
  "marquee":"Marquee [M]",
  "pencil":"Pencil [B]",
  "line":"Line [L]",
  "arrow":"Arrow [A]",
  "rect":"Rectangle [R]",
  "erase":"Erase [E]",
  "hand":"Hand [H]",
  "zoom":"Zoom [Z]"
}
var rightClickAction={
  "pencil":true,
  "line":true,
  "arrow":true,
  "rect":true
}
var toolButtons={}
function toolButton(name, title){
  let b = document.createElement('button')
  b.className="tool"
  b.style.backgroundImage=`url(icons/${name}.png)`
  b.title=title||"";
  toolButtons[name]=b
  toolbox.append(b)
  return b
}
function toolButtonSpacer(){
  toolbox.append(document.createTextNode(' - '))
}

toolButton("sidebar", "Toggle Sidebar [S]").onclick=toggleSidebarLeft
toolButtonSpacer()

for (let i of ["addnote","marquee","pencil","line","arrow","rect","erase","hand","zoom"]) {
  toolButton(i, toolTips[i]).onclick=function(){
    if (penTool==i)
      setPenTool("none")
    else
      setPenTool(i)
  }
}

toolButtonSpacer()
toolButton("zoom100", "Zoom to 100% [Home]").onclick = zoomReset
toolButton("zoomfit", "Zoom fit [End]").onclick = zoomFit
toolButtonSpacer()
toolButton("help", "Help").onclick = openHelp

reloadAll()
</script>
